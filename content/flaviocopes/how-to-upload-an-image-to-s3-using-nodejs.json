{
  "title": "How to upload an image to S3 using Node.js",
  "url": "https://flaviocopes.com/node-aws-s3-upload-image/",
  "date": "Tue, 12 Apr 2022 07:00:00 +0200",
  "content": "        <p>In this post I want to share how to upload an image to AWS S3, the wonderful cloud file hosting solution provided by Amazon Web Services.</p><blockquote><p>I already wrote about this topic in the past in <a href=\"https://flaviocopes.com/node-upload-files-s3/\">how to upload files to S3 from Node.js</a></p></blockquote><p>First, install the <code>aws-sdk</code> library:</p><pre tabindex=\"0\"><code>npm install aws-sdk</code></pre><p>Import it in your code at the top of the file you&rsquo;re going to add this file upload to S3 functionality:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >import</span> <span >AWS</span> <span >from</span> <span >&#39;aws-sdk&#39;</span></code></pre></div><p>Next, use the SDK to create an instance of the S3 object. I assign it to a <code>s3</code> variable:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >const</span> <span >s3</span> <span >=</span> <span >new</span> <span >AWS</span>.<span >S3</span>({  <span >accessKeyId</span><span >:</span> <span >process</span>.<span >env</span>.<span >AWS_S3_ACCESS_KEY_ID</span>,  <span >secretAccessKey</span><span >:</span> <span >process</span>.<span >env</span>.<span >AWS_S3_SECRET_ACCESS_KEY</span>,})</code></pre></div><p>Note that I use two <a href=\"https://flaviocopes.com/node-environment-variables/\">environment variables</a> here: <code>AWS_S3_ACCESS_KEY_ID</code> and <code>AWS_S3_SECRET_ACCESS_KEY</code>.</p><p>Now comes some &ldquo;administrative work&rdquo;. You need to create an IAM profile on AWS (the credentials) with programmatic access with the permissions for <code>AWSCloudFormationFullAccess</code> and <code>AmazonS3FullAccess</code> and an S3 bucket that this user has access to.</p><p>I won&rsquo;t cover this aspect here as you can find tons of articles and documentation about this. I&rsquo;ll just talk about the JavaScript code you need.</p><p>Now, you need an <strong>image blob</strong> to upload.</p><p>You can use a URL like this:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >const</span> <span >imageURL</span> <span >=</span> <span >&#39;https://url-to-image.jpg&#39;</span><span >const</span> <span >res</span> <span >=</span> <span >await</span> <span >fetch</span>(<span >imageURL</span>)<span >const</span> <span >blob</span> <span >=</span> <span >await</span> <span >res</span>.<span >buffer</span>()</code></pre></div><p>or you can get an image sent from a form image field upload in a <a href=\"https://flaviocopes.com/nextjs-upload-files/\">multipart form</a>:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >const</span> <span >imagePath</span> <span >=</span> <span >req</span>.<span >files</span>[<span >0</span>].<span >path</span><span >const</span> <span >blob</span> <span >=</span> <span >fs</span>.<span >readFileSync</span>(<span >imagePath</span>)</code></pre></div><p>Finally, make a call to <code>s3.upload()</code> and call its <code>.promise()</code> method so you can use await to wait until it finishes to get the uploaded file object:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >const</span> <span >uploadedImage</span> <span >=</span> <span >await</span> <span >s3</span>.<span >upload</span>({  <span >Bucket</span><span >:</span> <span >process</span>.<span >env</span>.<span >AWS_S3_BUCKET_NAME</span>,  <span >Key</span><span >:</span> <span >req</span>.<span >files</span>[<span >0</span>].<span >originalFilename</span>,  <span >Body</span><span >:</span> <span >blob</span>,}).<span >promise</span>()</code></pre></div><blockquote><p><code>AWS_S3_BUCKET_NAME</code> is the name of the S3 bucket, another environment variable</p></blockquote><p>Finally, you can get the URL of the uploaded image on S3 by referencing the <code>Location</code> property:</p><div class=\"highlight\"><pre tabindex=\"0\" ><code class=\"language-js\" data-lang=\"js\"><span >uploadedImage</span>.<span >Location</span></code></pre></div><p>You have to make sure you <a href=\"https://flaviocopes.com/aws-s3-public/\">set the S3 bucket as public</a> so you can access that image URL.</p>      ",
  "image": "https://flaviocopes.com/img/avatar.png",
  "description": "In this post I want to share how to upload an image to AWS S3, the wonderful cloud file hosting solution provided by Amazon Web Services.\n I already wrote about this topic in the past in how to upload files to S3 from Node.js\n First, install the aws-sdk library:\nnpm install aws-sdk Import it in your code at the top of the file youâ€™re going to add this file upload to S3 functionality:",
  "publisher": "Flaviocopes",
  "publisherUrl": "https://flaviocopes.com/"
}